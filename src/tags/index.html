<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <title>Gestion des Tags</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 2rem auto;
        }

        input,
        button,
        select,
        textarea {
            padding: 0.5rem;
            margin: 0.3rem 0;
            width: 100%;
            max-width: 400px;
        }

        label {
            font-weight: bold;
            margin-top: 1rem;
            display: block;
        }

        .tag-item {
            border: 1px solid #ccc;
            padding: 1rem;
            margin-bottom: 0.8rem;
            border-radius: 6px;
        }

        .actions {
            margin-top: 0.5rem;
        }

        button {
            cursor: pointer;
        }
    </style>
</head>

<body>
    <h1>Gestion des Tags</h1>

    <section>
        <h2>Créer un nouveau Tag</h2>
        <form id="createForm">
            <label for="name">Nom *</label>
            <input type="text" id="name" name="name" required />

            <label for="slug">Slug (optionnel)</label>
            <input type="text" id="slug" name="slug" placeholder="ex: mon-tag" />

            <label for="icon">Icone (URL)</label>
            <input type="text" id="icon" name="icon" placeholder="URL image icone" />

            <label for="language">Langue *</label>
            <select id="language" name="language" required>
                <option value="fr">Français</option>
                <option value="en">Anglais</option>
                <!-- ajoute d'autres langues si besoin -->
            </select>

            <label for="type_id">Type (choisir)</label>
            <select id="type_id" name="type_id">
                <option value="">-- Aucun --</option>
            </select>

            <button type="submit">Créer</button>
        </form>
    </section>

    <hr />

    <section>
        <h2>Liste des Tags</h2>
        <div id="tagsList"></div>
    </section>

    <script>
        const apiBase = 'http://127.0.0.1:5000/api/tags'; // adapte selon ton API
        const apiTypesBase = 'http://127.0.0.1:5000/api/types'; // API types
        const token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MSwiZW1haWwiOiJiZWNhcmUuZnIuZ2VAZ21haWwuY29tIiwicGVybWlzc2lvbnMiOlsic3RvcmVfb3duZXIiXSwiaWF0IjoxNzUzMzQwMTc5LCJleHAiOjE3NTM5NDQ5Nzl9.QkegM5aJAbinqfb9z1pl8i5c_ZElbwzH2SNnEWRcmEU';

        const createForm = document.getElementById('createForm');
        const tagsList = document.getElementById('tagsList');

        async function fetchTags() {
            const res = await fetch(apiBase);
            if (!res.ok) {
                tagsList.textContent = 'Erreur lors de la récupération des tags.';
                return [];
            }
            const json = await res.json();
            const data = json.data || json;
            renderTags(data);
            await populateTypeSelects();
            return data;
        }

        function renderTags(tags) {
            tagsList.innerHTML = '';
            if (!tags.length) {
                tagsList.textContent = 'Aucun tag trouvé.';
                return;
            }

            tags.forEach(tag => {
                const div = document.createElement('div');
                div.className = 'tag-item';
                div.dataset.typeId = tag.type_id || '';

                div.innerHTML = `
          <strong>${tag.name}</strong> (${tag.slug}) - Langue: ${tag.language} <br/>
          <img src="${tag.icon || ''}" alt="Icone" width="30" height="30" onerror="this.style.display='none'" />
           
          <div class="actions">
            <button onclick="editTag(${tag.id})">Modifier</button>
            <button onclick="deleteTag(${tag.id})" style="color:red;">Supprimer</button>
          </div>
          <div id="editForm-${tag.id}" style="display:none; margin-top:10px;">
            <input type="text" id="editName-${tag.id}" value="${tag.name}" placeholder="Nom" />
            <input type="text" id="editSlug-${tag.id}" value="${tag.slug}" placeholder="Slug" />
            <input type="text" id="editIcon-${tag.id}" value="${tag.icon || ''}" placeholder="Icone URL" />
            <select id="editLanguage-${tag.id}">
              <option value="fr" ${tag.language === 'fr' ? 'selected' : ''}>Français</option>
              <option value="en" ${tag.language === 'en' ? 'selected' : ''}>Anglais</option>
            </select>
            <label for="editTypeId-${tag.id}">Type (choisir)</label>
            <select id="editTypeId-${tag.id}">
              <option value="">-- Aucun --</option>
            </select>
            <button onclick="submitEdit(${tag.id})">Enregistrer</button>
            <button onclick="cancelEdit(${tag.id})">Annuler</button>
          </div>
        `;

                tagsList.appendChild(div);
            });
        }

        async function populateTypeSelects() {
            const types = await fetchTypes();

            // Select création
            const createSelect = document.getElementById('type_id');
            createSelect.innerHTML = '<option value="">-- Aucun --</option>';
            types.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.id;
                opt.textContent = t.name;
                createSelect.appendChild(opt);
            });

            // Selects édition
            document.querySelectorAll('select[id^="editTypeId-"]').forEach(select => {
                select.innerHTML = '<option value="">-- Aucun --</option>';
                types.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t.id;
                    opt.textContent = t.name;
                    select.appendChild(opt);
                });
            });
        }

        async function fetchTypes() {
            const res = await fetch(apiTypesBase);
            if (!res.ok) {
                console.error('Erreur récupération types');
                return [];
            }
            const json = await res.json();
            return json.data || json;
        }

        createForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(createForm);
            const data = Object.fromEntries(formData.entries());

            // Convert type_id en number ou null
            data.type_id = data.type_id ? Number(data.type_id) : null;

            try {
                const res = await fetch(apiBase, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data),
                });
                if (!res.ok) throw new Error('Erreur lors de la création');
                alert('Tag créé avec succès');
                createForm.reset();
                fetchTags();
            } catch (err) {
                alert(err.message);
            }
        });

        function editTag(id) {
            document.getElementById(`editForm-${id}`).style.display = 'block';
            const div = Array.from(tagsList.children).find(d => d.querySelector(`#editForm-${id}`));
            const typeId = div?.dataset.typeId || '';

            populateTypeSelects().then(() => {
                if (typeId) {
                    document.getElementById(`editTypeId-${id}`).value = typeId;
                }
            });
        }

        function cancelEdit(id) {
            document.getElementById(`editForm-${id}`).style.display = 'none';
        }

        async function submitEdit(id) {
            const name = document.getElementById(`editName-${id}`).value.trim();
            const slug = document.getElementById(`editSlug-${id}`).value.trim();
            const icon = document.getElementById(`editIcon-${id}`).value.trim();
            const language = document.getElementById(`editLanguage-${id}`).value;
            let type_id = document.getElementById(`editTypeId-${id}`).value;

            if (!name || !language) {
                alert('Le nom et la langue sont obligatoires');
                return;
            }

            type_id = type_id ? Number(type_id) : null;

            try {
                const res = await fetch(`${apiBase}/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ name, slug, icon, language, type_id }),
                });
                if (!res.ok) throw new Error('Erreur lors de la mise à jour');
                alert('Tag mis à jour');
                cancelEdit(id);
                fetchTags();
            } catch (err) {
                alert(err.message);
            }
        }

        async function deleteTag(id) {
            if (!confirm('Voulez-vous vraiment supprimer ce tag ?')) return;
            try {
                const res = await fetch(`${apiBase}/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (!res.ok) throw new Error('Erreur lors de la suppression');
                alert('Tag supprimé');
                fetchTags();
            } catch (err) {
                alert(err.message);
            }
        }

        // Chargement initial
        fetchTags();
    </script>
</body>

</html>